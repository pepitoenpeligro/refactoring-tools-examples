id: append_logger_import_after_last_import_from
language: python
rule:
  all:
    - kind: import_from_statement
    - pattern: $I
    - inside: { kind: module }
    - not:
        precedes:
          any:
            - kind: import_statement
            - kind: import_from_statement
          stopBy: neighbor
    - not:
        follows:
          any:
            - kind: function_definition
            - kind: class_definition
            - kind: decorated_definition
            - kind: assignment
            - kind: if_statement
            - kind: try_statement
            - kind: for_statement
            - kind: while_statement
          stopBy: end
    - not:
        inside:
          kind: module
          has:
            pattern: from aws_lambda_powertools import Logger
            stopBy: end
fix: |
  $I
  from aws_lambda_powertools import Logger
  logger = Logger()
message: "Add 'from aws_lambda_powertools import Logger' at the end of the import block."
# --- Notes ------------------------------------------------------------
# Matches the last `from ... import ...` in the initial import block and
# appends the Powertools import + `logger = Logger()`.
# We avoid duplicating the import with the final `not: inside ... has ...`.
# IMPORTANT: keep comments OUTSIDE the `fix: |` block, or they will be
# inserted into your Python file.
# ---------------------------------------------------------------------

---
id: replace_print_with_logger_info
language: python
rule:
  kind: call
  pattern: print($$$ARGS)
fix: logger.info($$$ARGS)
message: "Use logger.info(...) instead of print(...)."
# --- Notes ------------------------------------------------------------
# Replaces any `print(...)` call with `logger.info(...)`, preserving args.
# If you want to skip keyword-arg prints (sep=, end=, etc.), add:
#   not:
#     has:
#       kind: keyword_argument
# ---------------------------------------------------------------------

---
id: lambda_handler_insert_event_log_after_docstring
language: python
rule:
  all:
    # Target: the docstring itself (string expression) inside the body
    - kind: expression_statement
    - pattern: $DOC
    - has: { kind: string }
    # It must come immediately before another statement (we use follows in the next rule,
    # but here we rewrite the docstring to "add" the line below)
    - inside:
        all:
          # We work inside the block (body) of the function
          - kind: block
          # That block belongs to a typed lambda_handler (with or without return)
          - inside:
              all:
                - kind: function_definition
                - any:
                    - pattern: |
                        def lambda_handler(event: $T1, context: $T2) -> $RET:
                            $$$BODY
                    - pattern: |
                        def lambda_handler(event: $T1, context: $T2):
                            $$$BODY
          # Avoid adding if there is already a log/print of the event as a direct statement in the block
          - not:
              has:
                any:
                  - pattern: logger.$METHOD(event, $$$REST)
                  - pattern: print(event, $$$REST)
fix: |
  $DOC
  logger.info('Event received:', extra=event)
message: "Insert logger.info(event) after the docstring in lambda_handler(event, context)."
